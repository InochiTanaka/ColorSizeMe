<!DOCTYPE html>

<html lang="en">
<head>
    <title>User Inputs</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <link href="styles/bootstrap.min.css" rel="stylesheet" media="screen">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="JS/signup.js"></script>
    <script type="text/javascript" src="JS/Style.js"></script>
   
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/4.13.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/4.13.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-database.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="JS/FirebaseInitialScript.js"></script>
    <script type="text/javascript" src="JS/Style.js"></script>
    <script type="text/javascript" src="JS/navBar.js"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="styles/common.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="styles/navBar.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="styles/dropdownMenu.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="styles/iphone.css" />
           
</head>

<body>
<div id="wrap">
    <nav class="navbar navbar-inverse">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar" style="width:40px;"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="index.html">ColorSizeMe</a> </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Home</a></li>
                        <li><a href="#">About</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                    <ul id="loginTable" class="nav navbar-nav navbar-right">
                        <li id="login" onclick="loginFunction(location.pathname)">Log In</li>
                        <li id="messageText0">
                            <p></p>
                        </li>
                        <li id="signup" onclick="signupFunction()">Sign Up</li>
                        <li id="messageText1">
                            <p></p>
                        </li>
                        <li id="accountMenu" onclick="window.location='myprofile.html'"><img id="accountImage" src="" /></li>
                        <li id="logout" class="buttons" onclick="logoutFunction()">Log Out</li>
                    </ul>
                </div>
            </div>
        </nav>
    <div class="full wrap">
    <div class="container-fluid main" style="font-size: 1.3em;">
        <form onsubmit="new_user(); return false;" action="index.html">
                <!-- Form Name -->
                <label style="display: block;text-align: center;line-height: 150%;font-size: 1.3em;">Create Your Profile</label>

                <!-- Text input-->
                <div class="col-sm-12 form-group">
                  <label class="col-sm-4 control-label" for="fname">First Name</label>
                  <div class="col-sm-4">
                    <input id="fname" name="fname" type="text" placeholder="John" class="form-control input-sm" required="">
                    <span class="help-block" id="invalid_fname" style="color:red;display:none;font-size:15px;">Name can only contains alphabetic characters.</span>
                  </div>
                </div>

              <!-- Text input-->
              <div class="col-sm-12 form-group">
                <label class="col-sm-4 control-label" for="Last Name">Last Name</label>
                <div class="col-sm-4">
                <input id="lname" name="Last Name" type="text" placeholder="Doe" class="form-control input-sm" required="">
                <span class="help-block" id="invalid_lname" style="color:red;display:none;font-size:15px;">Name can only contains alphabetic characters.</span>
                </div>
              </div>

              <!-- Text input-->
              <div class="col-sm-12 form-group">
                <label class="col-sm-4 control-label" for="textinput">Username</label>
                <div class="col-sm-4">
                <input id="username" name="Username" type="text" placeholder="jdoe87" class="form-control input-sm" required="">
                <span class="help-block" id="invalid_username" style="display:inline;font-size:15px;"></span><span id="symbol" style="display:inline;"></span>
                </div>
              </div>

              <!-- File Button -->
              <div class="col-sm-12 form-group">
                <label class="col-sm-4 control-label" for="Profile Picture" >Profile Photo</label>
                <div class="col-sm-4">
                  <input type="file" class="btn btn-default" id="pic" name="Profile Picture">
                </div>
              </div>

              <!-- Text input-->
              <div class="col-sm-12 form-group">
                <label class="col-sm-4 control-label" for="towncity">City/Town</label>
                <div class="col-sm-4">
                <input id="towncity" name="towncity" type="text" placeholder="Burnaby" class="form-control input-sm" required="">
                <span class="help-block" id="invalid_loc1" style="color:red;display:none;font-size:15px;">Type in city/town</span>
                </div>
              </div>

              <!-- Text input-->
              <div class="col-sm-12 form-group">
                    <label class="col-sm-4 control-label" for="country">Country</label>
                    <div class="col-sm-4">
                    <input id="country" name="country" type="text" placeholder="Canada" class="form-control input-sm" required="">
                    <span class="help-block" id="invalid_loc2" style="color:red;display:none;font-size:15px;">Type in country</span>
                    </div>
              </div>
              
              <!-- Multiple Checkboxes (inline) -->
              <div class="col-sm-12 form-group">
                    <label class="col-sm-4 control-label" for="_Gender">Gender</label>
                    <div class="col-sm-4">
                    <label class="checkbox-inline" for="_Gender-0">
                      <input type="checkbox" name="_Gender" id="_Gender-0" value="male" required>
                        Male
                    </label>
                    <label class="checkbox-inline" for="_Gender-1">
                      <input type="checkbox" name="_Gender" id="_Gender-1" value="female" required>
                        Female
                    </label>
                    </div>
              </div>
                            
              <!-- Buttons-->
              <div class="btn-group form-group col-sm-4" style="display:block;margin-left:35%">
                <input type="submit" class="btn btn-default " value="Create Profile">
                <input type="button" class="btn btn-default" value="Cancel" onclick="window.location='index.html';">
              </div>
              <br>
              <div id="note" style="clear:both;text-align:center;font-size:20px;padding-top:10px;display:none;">The following measurement information is optional. You can edit this later in your user profile.</div>
            
            <!-- Measurement inputs-->             
            <div id = "measures" class="toggle" style="display:none;padding-top:20px;">"></div>                       
        </form>
    </div>
    </div>
</div>
    <footer class="navbar navbar-fixed-bottom">
      <div class="container">
        <p> Â© 2018 Copyright:</p>
      </div>
    </footer>

</body>

<script>
  var photoUploaded;
  var file;
  var username_avb;
  
  var condition1 = false;
  var condition2 = false;
  var condition3 = false;
  $(':input[type="submit"]').prop('disabled', true);
  
  //Validate the inputs
  function validate() {
    if (condition1 && condition2 && condition3)
      $(':input[type="submit"]').prop('disabled', false);
    else
      $(':input[type="submit"]').prop('disabled', true);
  }
  
	$("input[type=text]").attr( {
		maxlength : 50
    }); 
    //Sorted by class name of names! -or- A-Za-z
    $("#fname").keyup( function() {
        if (!(/^[A-Za-z]+$/.test(this.value))) {
          condition1 = false;
          $("#invalid_fname").show();
        } else {
          condition1 = true;
          $("#invalid_fname").hide();
        }
        validate();
    });
    
    $("#lname").keyup( function() {
        if (!(/^[A-Za-z]+$/.test(this.value))) {
          condition2 = false;
          $("#invalid_lname").show();
        } else {
          condition2 = true;
          $("#invalid_lname").hide();
        }
        validate();
    });
       
  //Username Regex
  $("#username").keyup( function() {
    if (!(/^[A-Za-z0-9]+(?:[_-][A-Za-z0-9]+)*$/.test(this.value))) {
      condition3 = false;
      document.getElementById("invalid_username").innerHTML = "Username cannot contain any spaces or special characters.";
      document.getElementById("invalid_username").style.color = "red";
      $("#invalid_username").show();
      $("#symbol").hide();
    } else        
      checkIfNew(this.value)
                       
    validate();
  });
  
  //Gender Selection
    $("input:checkbox").on('click', function() {
      var $box = $(this);
      var group = "input:checkbox[name='" + $box.attr("name") + "']";
      if ($box.is(":checked")) {        
        $(group).prop("checked", false);
        $(group).prop("required", false);
        $box.prop("checked", true);
      } else {
        $box.prop("checked", false);
        $(group).prop("required", true);
      }
    });
    
    $('#_Gender-0').click(function() {
      $('#note').show();
      append(men);
    });

    $('#_Gender-1').click(function() {
      $('#note').show();
      append(women);
    });
    
  //Auto geolocation. Requires permission. Pick this because SSL is required, which Google has
  //verify geo location https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition
	$("#towncity").click(()=> {
		$.getJSON('https://ipinfo.io/json', function(json) {
			//alert(JSON.stringify(json));
			$("#towncity").val(json.city);
			$("#country").val(json.country);
		});
	});
	  
  /*
    Checks if username is available. Returns TRUE if username already exists. False otherwise
  */
  function checkIfNew(dusername) {

    var taken;
    var uid = firebase.auth().currentUser.uid;  
    
    firebase.database().ref().child("takenusernames/").once('value', function(snapshot) {
      snapshot.forEach(function(childSnapshot) {

        if (childSnapshot.val() == dusername) {
            document.getElementById("invalid_username").innerHTML = "This user name is already taken. ";
            document.getElementById("invalid_username").style.color = "red";
            document.getElementById("symbol").style.color = "red";
            $("#symbol").html('&#10008;');
            $("#symbol").show();
            $("#invalid_username").show();
            
            username_avb = false;
            condition3 = false;
            taken = true;
        } else if (!taken) {        
            document.getElementById("invalid_username").innerHTML = "This user name is available. "; 
            document.getElementById("invalid_username").style.color = "green";
            document.getElementById("symbol").style.color = "green";
            $("#symbol").html('&#10004;');
            $("#symbol").show();
            $("#invalid_username").show();
            
            username_avb = true;
            condition3 = true;
            taken = false;
        }
    });
   });
   return username_avb;
  }
  
  /*
    Adds user to database. Puts generated/uploaded picture onto storage.
  */
  function new_user() {
    var db = firebase.database();
    var un = $("#username").val();
    var isAvailable = checkIfNew(un);
    
    if (isAvailable) {		
      var uid = firebase.auth().currentUser.uid;   
      var picture = $("#pic").val();      
      var fn = $("#fname").val();
      var ln = $("#lname").val();
      
      /*Process photo first, then define object below for database*/
      if (!file)  //check if user attached personal pic
        photoUploaded = "no";
      else	      
        uploadPhoto();
      
      public_use = {
        firstname : fn,
        lastname : ln,
        username : un,
        profilepic : photoUploaded,        
        citytown : $("#towncity").val(),
        country : $("#country").val()
      }
		
      private_use = {			
        username : un		
      }
		
      var visibility = 'public'; //default value on profile creation
      var usersRef = db.ref().child('users/' + uid); //data node for public-visibility
      
      usersRef.set({
        private_use,
        public_use,
        visibility
      });
		
      var takenUsersRef = db.ref('takenusernames/' + uid);
      takenUsersRef.set(un);
      
      var geoRef = db.ref().child('market/' + $("#country").val() + '/' + uid); //Geomaps the user	
      geoRef.set(public_use);	
         
      $("#symbol").hide();
      $("#invalid_username").hide();
      
      create(un);
      alert("Profile created successfully.");      
    } else {
        /* RETURN? Sorry, USERNAME USED / Email is USED!*/
		//event.preventDefault();
		alert("Username is not available. Please try again");
    }
    /*PROMISE HERE*/
    /*ERROR-HANDLING*/       
  }
  
  /*
    Stores photo on cloud storage.
  */
   
  //Get Elements
  var fileButton = document.getElementById('pic');
  //Listen for file 
  fileButton.onchange = function(event) {
    
    //Get File
    file = fileButton.files[0];   
  }
  
  function uploadPhoto() {
    var uid = firebase.auth().currentUser.uid; 
    
    //Create a Storage Ref
    var storageRef = firebase.storage().ref('profilePictures/' + uid + '.jpg');
    
    //Upload file
    var task = storageRef.put(file);
    photoUploaded =  "yes";
  }
  
</script>

</html> 