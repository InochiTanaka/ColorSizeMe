<!DOCTYPE html>

<html lang="en">
<head>
  <title>User Inputs</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="styles/style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="JS/userdata.js"></script>
   
  <!-- update the version number as needed -->
    <script defer src="/__/firebase/4.13.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/4.13.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-database.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
       
</head>
<body>
<form class="form-horizontal" onsubmit="new_user()" action="index.html">
<fieldset>

<!-- Form Name -->
<legend>Create Your Profile</legend>

<!-- Text input-->
<div class="form-group">
  <label class="col-sm-4 control-label" for="fname">First Name</label>  
  <div class="col-sm-4">
  <input id="fname" name="fname" type="text" placeholder="John" class="form-control input-sm" required="">
  <span class="help-block" id="invalid_fname" style="color:red;display: none;">Name can only contains alphabetic characters.</span>  
  </div>
</div>

<!-- Text input-->
<div class="form-group">
  <label class="col-sm-4 control-label" for="Last Name">Last Name</label>  
  <div class="col-sm-4">
  <input id="lname" name="Last Name" type="text" placeholder="Doe" class="form-control input-sm" required="">
  <span class="help-block" id="invalid_lname" style="color:red;display: none;">Name can only contains alphabetic characters.</span>  
  </div>
</div>

<!-- Text input-->
<div class="form-group">
  <label class="col-sm-4 control-label" for="textinput">Username</label>  
  <div class="col-sm-4">
  <input id="user" name="username" type="text" placeholder="jdoe87" class="form-control input-sm" required="">
  <span class="help-block" id="invalid_username" style="display:inline;"></span><span id="symbol" style="display:inline;"></span>  
  </div>
</div>

<!-- File Button --> 
<div class="form-group">
  <label class="col-sm-4 control-label" for="Profile Picture">File Button</label>
  <div class="col-sm-4">
    <input id="Profile Picture" name="Profile Picture" class="input-file" type="file">
  </div>
</div>

<!-- Text input-->
<div class="form-group">
  <label class="col-sm-4 control-label" for="towncity">City/Town</label>  
  <div class="col-sm-4">
  <input id="towncity" name="towncity" type="text" placeholder="Burnaby" class="form-control input-sm" required="">
  <span class="help-block" id="invalid_loc1" style="color:red;display: none;">Type in city/town</span>  
  </div>
</div>

<!-- Text input-->
<div class="form-group">
  <label class="col-sm-4 control-label" for="country">Country</label>  
  <div class="col-sm-4">
  <input id="country" name="country" type="text" placeholder="Canada" class="form-control input-sm" required="">
  <span class="help-block" id="invalid_loc2" style="color:red;display: none;">Type in country</span>  
  </div>
</div>

</fieldset>

<!-- Buttons-->
<div id="buttons">
  <div class="row">
    <div class="cell">
      <input type="submit" value="Create Profile">
      <input type="button" value="Cancel" onclick="window.location='index.html';">
    </div>
  </div>
</div>

</form>

</body>

<script>
  var condition1 = false;
  var condition2 = false;
  var condition3 = false;

  $(':input[type="submit"]').prop('disabled', true);
  
  //Validate the inputs
  function validate() {
    if (condition1 && condition2 && condition3)
      $(':input[type="submit"]').prop('disabled', false);
    else
      $(':input[type="submit"]').prop('disabled', true);
  }
  
	$("input[type=text]").attr( {
		maxlength : 50
    }); 

    //Sorted by class name of names! -or- A-Za-z
    $("#fname").keyup( function() {
        if (!(/^[A-Za-z]+$/.test(this.value))) {
          condition1 = false;
          $("#invalid_fname").show();
        } else {
          condition1 = true;
          $("#invalid_fname").hide();
        }
        validate();
    });
    
    $("#lname").keyup( function() {
        if (!(/^[A-Za-z]+$/.test(this.value))) {
          condition2 = false;
          $("#invalid_lname").show();
        } else {
          condition2 = true;
          $("#invalid_lname").hide();
        }
        validate();
    });
       
  //Username Regex
  $("#user").keyup( function() {
    if (!(/^[A-Za-z0-9]+(?:[_-][A-Za-z0-9]+)*$/.test(this.value))) {
      condition3 = false;
      document.getElementById("invalid_username").innerHTML = "Username can only contain alphabetic, numeric and -,_ characters. ";
      document.getElementById("invalid_username").style.color = "red";
      $("#invalid_username").show();
      $("#symbol").hide();
    } else        
      checkIfNew(this.value)
        
                
    validate();
  });

  //Auto geolocation. Requires permission. Pick this because SSL is required, which Google has
  //verify geo location https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition
	$("#towncity").click(()=> {
		$.getJSON('https://ipinfo.io/json', function(json) {
			//alert(JSON.stringify(json));
			$("#towncity").val(json.city);
			$("#country").val(json.country);
		});
	});
	  
  /*
    Checks if username is available. Returns TRUE if username already exists. False otherwise
  */
  function checkIfNew(dusername) {
    var username_avb;
    firebase.database().ref().child("users")
            .orderByChild("username").equalTo(dusername).on('value', function(snapshot) {
        if (snapshot.exists()) {
            document.getElementById("invalid_username").innerHTML = "This user name is already taken. ";
            document.getElementById("invalid_username").style.color = "red";
            document.getElementById("symbol").style.color = "red";
            $("#symbol").html('&#10008;');
            $("#symbol").show();
            $("#invalid_username").show();
            
            username_avb = false;
            condition3 = false;
        } else {        
            document.getElementById("invalid_username").innerHTML = "This user name is available. "; 
            document.getElementById("invalid_username").style.color = "green";
            document.getElementById("symbol").style.color = "green";
            $("#symbol").html('&#10004;');
            $("#symbol").show();
            $("#invalid_username").show();
            
            username_avb = true;
            condition3 = true;
        }
    });
    return username_avb;
  }

  function new_user() {  
    alert("Profile created successfully!");
  }
</script>
</html> 
 