<!DOCTYPE html>

<html lang="en">
<head>
  <title>Profile Page</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="styles/style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="JS/signup.js"></script>
  <script type="text/javascript" src="JS/Style.js"></script>
  <script type="text/javascript" src="JS/navBar.js"></script>
   
  <!-- update the version number as needed -->
    <script defer src="/__/firebase/4.13.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/4.13.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-database.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-storage.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
    
    <link rel="stylesheet" type="text/css" media="screen" href="styles/style.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="styles/navBar.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="styles/iphone.css" />
    <style media="screen"></style>
</head>
<body>

<div id="wrap">
        <nav class="navbar navbar-inverse">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar" style="width:40px;"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="index.html">ColorSizeMe</a> </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Home</a></li>
                        <li><a href="#">About</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                    <ul id="loginTable" class="nav navbar-nav navbar-right">
                        <li id="login" onclick="loginFunction()">Log In</li>
                        <li id="messageText0">
                            <p></p>
                        </li>
                        <li id="signup" onclick="signupFunction()">Sign Up</li>
                        <li id="messageText1">
                            <p></p>
                        </li>
                        <li>
                            <div id="accountMenu" onclick="location.href='myprofile.html';"> <img id="accountImage" src="">
                                <!--
                                    <div class="dropDownSign"></div>
                                    <ul id="menu">
                                        <li>
                                            <a id="accountMenu" href="#"><img id="accountImage" src=""><div class="dropDownSign"/></a>
                                            <a href="#">Categories</a>
                                            <ul>
                                                <li><a href="#">CSS</a></li>
                                                <li><a href="#">Graphic design</a></li>
                                                <li><a href="#">Development tools</a></li>
                                                <li><a href="#">Web design</a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                  --></div>
                        </li>
                        <li id="logout" class="buttons" onclick="logoutFunction()">Log Out</li>
                    </ul>
                </div>
            </div>
        </nav>
</div>
            
<img src="" alt="Avatar" width="200" height="200" id="avatar" style="display:none;">

<span id="privacy" style="display:none;">
  <span style="position:relative;bottom:15px";>Private mode</span>
  
  <!-- Rounded switch -->
  <label class="switch">
    <input id="toggle" type="checkbox" onclick="setPrivacy()">
    <span class="slider round"></span>
  </label>
</span>

<div>
  <button id="change" value="Change" onclick="changeAvatar()" style="width:80px;display:none;">Change</button>
  <button id="remove" value="Remove" onclick="removeAvatar()" style="width:80px;display:none;">Remove</button>
</div>

<br>

<input id="pic" name="Profile Picture" class="input-file" type="file" style="display:none;">

<br>

<div class="form-group">
  <label for="fname">First Name: </label>  
  <span id ="firstname"></span>
  <input id="fname" name="fname" type="text" value="" style="display:none;">
  <span class="help-block" id="invalid_fname" style="color:red;display: none;">Name can only contains alphabetic characters.</span>   
</div>

<div class="form-group">
  <label for="lname">Last Name: </label>  
  <span id ="lastname"></span>
  <input id="lname" name="lname" type="text" value="" style="display:none;">
  <span class="help-block" id="invalid_lname" style="color:red;display: none;">Name can only contains alphabetic characters.</span>   
</div>

<div class="form-group">
  <label for="username">Username: </label>  
  <span id ="uname"></span>
  <input id="username" name="uname" type="text" value="" style="display:none;">
  <span class="help-block" id="invalid_username" style="display:inline;"></span><span id="symbol" style="display:inline;"></span>   
</div>

<div class="form-group">
  <label for="towncity">City/Town: </label>  
  <span id ="citytown"></span>
  <input id="towncity" name="towncity" type="text" value="" style="display:none;">
  <span class="help-block" id="invalid_loc1" style="color:red;display: none;">Type in city/town</span>    
</div>


<div class="form-group">
  <label for="country">Country: </label>  
  <span id ="ctry"></span>
  <input id="country" name="country" type="text" value="" style="display:none;">
  <span class="help-block" id="invalid_loc2" style="color:red;display: none;">Type in country</span>    
</div>

<button id="edit" onclick="edit()" value="Edit">Edit</button>
<br>
<button id="save" onclick="save()" value="Save" style="display:none;">Save</button>
<br>
<br>
<button onclick="deleteAccount()" id="delete" value="Delete" style="display:none;">Delete Account</button>

<script>
var firstname;
var lastname;
var username;
var photo;
var city;
var country;

var db;
var uid;
var storageRef;

var refreshIntervalId  = window.setInterval(loadProfile, 500);

if (typeof firebase != 'undefined')
  clearInterval(refreshIntervalId);

function loadProfile() {
  db = firebase.database(); 
  uid = firebase.auth().currentUser.uid; 
  storageRef = firebase.storage().ref();
  
  db.ref('/users/' + uid).once('value').then(function(snapshot) {
    visibility = snapshot.val().visibility;
    
    if (visibility == "private")   
      $("#toggle").prop('checked', true);
    else
      $("#toggle").prop('checked', false);
  });
  
  db.ref('/users/' + uid + '/public_use').once('value').then(function(snapshot) {
    firstname = snapshot.val().firstname;
    lastname = snapshot.val().lastname;
    username = snapshot.val().username;
    photo = snapshot.val().profilepic;
    city = snapshot.val().citytown;
    country = snapshot.val().country;
    
    document.getElementById("firstname").innerHTML = firstname;
    document.getElementById("lastname").innerHTML = lastname;
    document.getElementById("uname").innerHTML = username;
    document.getElementById("citytown").innerHTML = city;
    document.getElementById("ctry").innerHTML = country;
    
    if (photo == "yes") {
      storageRef.child('profilePictures/' + uid + '.jpg').getDownloadURL().then(function(url) { 
        var path = url;       
        upload(path);
        document.getElementById("avatar").src = path;
      }).catch(function(error) { });
    } else {
      storageRef.child('profilePictures/anonymous-avatar-sm.jpg').getDownloadURL().then(function(url) {
        var path = url;
        document.getElementById("avatar").src = path;
      }).catch(function(error) { });
    }
    
    $("#avatar").show();
  });
}

function edit() {
  document.getElementById("fname").value = firstname;
  document.getElementById("lname").value = lastname;
  document.getElementById("username").value = username;
  document.getElementById("towncity").value = city;
  document.getElementById("country").value = country;
 
  $("#edit").hide();
  $("#save").show();
  
  $("#fname").show();
  $("#firstname").hide();
  
  $("#lname").show();
  $("#lastname").hide();
  
  $("#username").show();
  $("#uname").hide();
  
  $("#towncity").show();
  $("#citytown").hide();
  
  $("#country").show();
  $("#ctry").hide();
  
  $("#change").show();
  $("#remove").show();
  
  $("#privacy").show();
  $("#delete").show();
}

function save() {
  db.ref('users/' + uid + '/public_use').update({ firstname: $("#fname").val() });
  db.ref('users/' + uid + '/public_use').update({ lastname: $("#lname").val() });
  db.ref('users/' + uid + '/private_use').update({ username: $("#username").val() });
  db.ref('users/' + uid + '/public_use').update({ username: $("#username").val() });
  db.ref('users/' + uid + '/public_use').update({ citytown: $("#towncity").val() });
  db.ref('users/' + uid + '/public_use').update({ country: $("#country").val() });
  
  $("#edit").show();
  $("#save").hide();
  
  $("#fname").hide();
  $("#firstname").show();
  
  $("#lname").hide();
  $("#lastname").show();
  
  $("#username").hide();
  $("#uname").show();
  $("#symbol").hide();
  $("#invalid_username").hide();
  
  $("#towncity").hide();
  $("#citytown").show();
  
  $("#country").hide();
  $("#ctry").show();
  
  $("#change").hide();
  $("#remove").hide();
  $("#pic").hide();
  
  $("#privacy").hide();
  $("#delete").hide();
}

function deleteAccount() {
  var sure = confirm("Are you sure you want to delete your account?");
  
  if (sure) {   
    firebase.auth().currentUser.delete().then(function () {
      //console.log('delete successful?');
      //console.log(app.auth().currentUser);
      
      db.ref('/users/' + uid).remove();
      db.ref('takenusernames/' + uid).remove();
          
      window.location.href = 'index.html';
      alert("Profile deleted successfully.");  
    }).catch(function (error) {
      console.error({error});
      alert("Please sign out and sign in again to delete your profile.");  
    })
  }
}

function changeAvatar() {  
  $("#pic").show();
}

function removeAvatar() {
  db.ref('users/' + uid + '/public_use').update({ profilepic: "no" });
  upload(null);
  
  // Create a reference to the file to delete
  var desertRef = storageRef.child('profilePictures/' + uid + '.jpg');

  // Delete the file
  desertRef.delete().then(function() {
    // File deleted successfully
  }).catch(function(error) {
    // Uh-oh, an error occurred!
  });
}

function setPrivacy(){
  var privatemode = document.getElementById("toggle").checked;
                
  if (privatemode)
    db.ref('users/' + uid).update({ visibility: "private" });
  else
    db.ref('users/' + uid).update({ visibility: "public" });               
}

</script>

<script>
  var username_avb;

  var condition1 = false;
  var condition2 = false;
  var condition3 = false;
  $(':input[type="submit"]').prop('disabled', true);
  
  //Validate the inputs
  function validate() {
    if (condition1 && condition2 && condition3)
      $(':input[type="submit"]').prop('disabled', false);
    else
      $(':input[type="submit"]').prop('disabled', true);
  }
  
	$("input[type=text]").attr( {
		maxlength : 50
    }); 
    //Sorted by class name of names! -or- A-Za-z
    $("#fname").keyup( function() {
        if (!(/^[A-Za-z]+$/.test(this.value))) {
          condition1 = false;
          $("#invalid_fname").show();
        } else {
          condition1 = true;
          $("#invalid_fname").hide();
        }
        validate();
    });
    
    $("#lname").keyup( function() {
        if (!(/^[A-Za-z]+$/.test(this.value))) {
          condition2 = false;
          $("#invalid_lname").show();
        } else {
          condition2 = true;
          $("#invalid_lname").hide();
        }
        validate();
    });
       
  //Username Regex
  $("#username").keyup( function() {
    if (!(/^[A-Za-z0-9]+(?:[_-][A-Za-z0-9]+)*$/.test(this.value))) {
      condition3 = false;
      document.getElementById("invalid_username").innerHTML = "Username can only contain alphabetic, numeric and -,_ characters. ";
      document.getElementById("invalid_username").style.color = "red";
      $("#invalid_username").show();
      $("#symbol").hide();
    } else        
      checkIfNew(this.value)
                       
    validate();
  });
	  
  /*
    Checks if username is available. Returns TRUE if username already exists. False otherwise
  */
  function checkIfNew(dusername) {

    var taken;
    var uid = firebase.auth().currentUser.uid;  
    
    db.ref().child("takenusernames/").once('value', function(snapshot) {
      snapshot.forEach(function(childSnapshot) {

        if (childSnapshot.val() == dusername) {
            document.getElementById("invalid_username").innerHTML = "This user name is already taken. ";
            document.getElementById("invalid_username").style.color = "red";
            document.getElementById("symbol").style.color = "red";
            $("#symbol").html('&#10008;');
            $("#symbol").show();
            $("#invalid_username").show();
            
            username_avb = false;
            condition3 = false;
            taken = true;
        } else if (!taken) {        
            document.getElementById("invalid_username").innerHTML = "This user name is available. "; 
            document.getElementById("invalid_username").style.color = "green";
            document.getElementById("symbol").style.color = "green";
            $("#symbol").html('&#10004;');
            $("#symbol").show();
            $("#invalid_username").show();
            
            username_avb = true;
            condition3 = true;
            taken = false;
        }
    });
   });
   return username_avb;
  }
  
   //Get Elements
  var fileButton = document.getElementById('pic');
  //Listen for file 
  fileButton.onchange = function(event) {
    
    //Get File
  var file = fileButton.files[0];   
  uploadPhoto(file);
  }
  
  function uploadPhoto(file) {
    var uid = firebase.auth().currentUser.uid; 
    
    //Create a Storage Ref
    var storageRef = firebase.storage().ref('profilePictures/' + uid + '.jpg');
    
    //Upload file
    var task = storageRef.put(file);
    db.ref('users/' + uid + '/public_use').update({ profilepic: "yes" });
  }
</script>

</body>

</html> 
 